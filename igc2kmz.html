<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=2.0, user-scalable=yes" />
    <title>igc2kmz</title>
    <script src="./dist/igc2kmz.min.js"></script>
    <style type="text/css">
      body {
        font-family: sans-serif;
      }
      label {
        display: inline-block;
        margin: 0px 10px 5px 0px;
      }
      .converter {
        width: 400px;
      }
      .button {
        float:right;
        cursor: pointer;
        border: solid 1px white;
        color: white;
        padding: 10px 30px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 4px;
        background-color: #008CBA;
      }
      .button:hover {
        border-color: #0000ff;
      }
      .red {
        background-color: #df1313;
      }
      .green {
        background-color: #4CAF50;
      }
      #tzoffset {
        width: 40px;
      }
      #lblfile {
        display: inline-block !important;
        margin: 10px;
        color: #ffafaf;
        text-shadow: 0 0 2px #7ef504, 0 0 2px #6cd900;
        font-size: 11pt;
        max-width: 380px;
        padding: 0 0 0 10px;
        max-height: 170px;
        overflow-y: auto;
        overflow-x: hidden;
      }
      #lblfile li {
        list-style: none;
        color: #1d8802;
      }
      #lblfile li.task {
        color: #005faf;
      }
      #lblfile li:hover {
        text-decoration: underline;
      }
      #dropbox {
        border: 1px dashed brown;
        border-width: thin;
        background-color: #dfffa0;
        text-align: center;
        height : 180px;
        width:400px;
        display: table-cell;
        vertical-align: middle;
        cursor:pointer;
      }
      #nofile:hover {
        text-decoration: underline;
      }
    </style>

    <script>
const default_filename = "track$i.igc";
var igccontent = [];
var filename = [];
var taskcontent = '';
var taskfilename = '';
var nbrfiles = 0;
function convertigc() {
  let tzoffset = parseFloat(window.tzoffset.value);
  if (isNaN(tzoffset)) tzoffset = 0;
  igc2kmz(igccontent, filename, tzoffset, taskcontent).catch(err => {
    alert(err);
    throw err;
  });
}
function loadfile(file, name) {
  name = typeof name === 'string' && name.length > 0 ? name.split('\\').pop() : default_filename.replace('$i', window.nbrfiles+1);
  const reader = new FileReader();
  reader.addEventListener('load', (event) => {
    let filesize = 0;
    if (name.trim().toLowerCase().endsWith('.igc')) {
      window.igccontent.push(reader.result);
      window.filename.push(name);
    } else {
      taskcontent = reader.result;
      taskfilename = name;
    }
    window.nbrfiles++;
    updateListFiles();
    btnConvert.style.display = 'initial';
    btnClear.style.display = 'initial';
  });
  reader.readAsText(file);
}
function dragenter(e) {
  e.stopPropagation();
  e.preventDefault();
  e.srcElement.style.backgroundColor = '#a0ffdf';
}
function dragleave(e) {
  e.srcElement.style.backgroundColor = '#dfffa0';
}
function dragover(e) {
  e.stopPropagation();
  e.preventDefault();
}
function drop(e) {
  e.stopPropagation();
  e.preventDefault();
  e.srcElement.style.backgroundColor = '#dfffa0';

  let dt = e.dataTransfer;
  let files = dt.files;

  for (let i=0; i<files.length; i++) {
    loadfile(files[i], files[i].name);
  }
  fileselector.value = '';
}
function selectFile() {
  const event = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  fileselector.dispatchEvent(event);
}
function clearFiles() {
  window.igccontent = [];
  window.filename = [];
  taskcontent = '';
  taskfilename = '';
  btnConvert.style.display = 'none';
  btnClear.style.display = 'none';
  updateListFiles();
}
function updateListFiles() {
  let filesnames = window.filename.map(f => '<li class="flight">'+f+'</li>');
  if (taskfilename.length > 0) {
    filesnames.push('<li class="task">'+taskfilename+'</li>')
  }
  nofile.style.display = (filesnames.length > 0) ? 'none':'initial';
  lblfile.style.display = (filesnames.length > 0) ? 'initial':'none';
  lblfile.innerHTML = filesnames.join('');
}
window.onload = function() {
  window.fileselector = document.getElementById('file-selector');
  window.dropbox = document.getElementById("dropbox");
  window.lblfile = document.getElementById("lblfile");
  window.btnConvert = document.getElementById("btnConvert");
  window.btnClear = document.getElementById("btnClear");
  window.tzoffset = document.getElementById("tzoffset");
  window.nofile = document.getElementById("nofile");
  updateListFiles();

  dropbox.addEventListener("dragenter", dragenter, false);
  dropbox.addEventListener("dragleave", dragleave, false);
  dropbox.addEventListener("dragover", dragover, false);
  dropbox.addEventListener("drop", drop, false);
  fileselector.addEventListener('change', (event) => {
    const files = event.target.files;
    if (files.length <= 0) return;
    for (let i=0; i<files.length; i++) {
      loadfile(files.item(i), files.item(i).name);
    }
    fileselector.value = '';
  });
}
      </script>
  </head>
<body>
  <div class="converter">
    <h1>IGC to KMZ conversion</h1>
    <label for="tzoffset">Timezone offset (hours) :</label><input type="number" id="tzoffset" min="-12" max="12">
    <input type="file" id="file-selector" accept=".igc,.xctsk" multiple style="display:none;">
    <div id="dropbox" onclick="selectFile();">
      <div id="nofile">drop .IGC/task files here<BR>or click to select</div>
      <ul id="lblfile" title="click to add files"></ul>
    </div>
    <input id="btnConvert" type="button" class="button" title="convert selected files" onclick="convertigc()" value="Convert" style="display:none;">
    <input id="btnClear" type="button" class="button red" title="clear current files" onclick="clearFiles()" value="Clear" style="display:none;">
  </div>
</body>
</html>
